<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DermBill AI - Billing Optimizer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .input-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .input-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .input-section textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .input-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: #495057;
            background: #e9ecef;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .results-section {
            padding: 30px;
            min-height: 300px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .placeholder {
            text-align: center;
            color: #adb5bd;
            padding: 60px 20px;
        }

        .placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e9ecef;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .billing-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .billing-table th,
        .billing-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .billing-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .billing-table tr:hover {
            background: #f8f9fa;
        }

        .total-row {
            font-weight: 700;
            background: #e7f1ff !important;
        }

        .total-row td {
            color: #667eea;
        }

        .wrvu-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }

        .status-supported {
            color: #28a745;
        }

        .status-missing {
            color: #dc3545;
        }

        .enhancement-card, .opportunity-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .enhancement-card.high {
            border-left-color: #dc3545;
        }

        .enhancement-card.medium {
            border-left-color: #ffc107;
        }

        .enhancement-card h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .enhancement-card p, .opportunity-card p {
            margin: 8px 0;
            color: #666;
            font-size: 14px;
        }

        .delta-positive {
            color: #28a745;
            font-weight: 600;
        }

        .suggested-text {
            background: #e7f1ff;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
            border: 1px solid #b8daff;
        }

        .optimized-note {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            border: 1px solid #e9ecef;
            max-height: 400px;
            overflow-y: auto;
        }

        .copy-btn {
            padding: 8px 16px;
            font-size: 13px;
            margin-top: 10px;
        }

        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-box h3 {
            margin-bottom: 15px;
        }

        .summary-stats {
            display: flex;
            gap: 30px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .gap-list {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .gap-list h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .gap-list ul {
            margin-left: 20px;
            color: #856404;
        }

        .gap-list li {
            margin: 5px 0;
        }

        .entities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .entity-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .entity-box h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .entity-box ul {
            list-style: none;
        }

        .entity-box li {
            padding: 4px 0;
            color: #495057;
            font-size: 14px;
        }

        .compliance-notice {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 12px;
            color: #6c757d;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .category-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .category-comorbidity { background: #d4edda; color: #155724; }
        .category-procedure { background: #cce5ff; color: #004085; }
        .category-visit_level { background: #fff3cd; color: #856404; }
        .category-documentation { background: #e2e3e5; color: #383d41; }

        .tier-options {
            background: #f0f7ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
        }

        .tier-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tier-options label:hover {
            background: #e0edff;
        }

        .tier-options input[type="radio"] {
            transform: scale(1.2);
        }

        .tier-code {
            font-weight: 600;
            color: #004085;
        }

        .tier-wrvu {
            color: #28a745;
            font-weight: 600;
            margin-left: auto;
        }

        .tier-threshold {
            color: #6c757d;
            font-size: 12px;
        }

        .totals-summary {
            background: #e7f1ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .totals-summary .total-row-dynamic {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #b8daff;
        }

        .totals-summary .total-row-dynamic:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1em;
            color: #667eea;
        }

        .delta-highlight {
            background: #d4edda;
            color: #155724;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .opportunity-row {
            background: #f0fff4 !important;
        }

        .opportunity-row:hover {
            background: #e6ffed !important;
        }

        .count-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #f0f7ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
        }

        .count-input-group label {
            font-weight: 600;
            color: #004085;
        }

        .count-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        .count-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
        }

        .code-family-badge {
            display: inline-block;
            padding: 2px 6px;
            background: #e9ecef;
            border-radius: 3px;
            font-size: 11px;
            color: #6c757d;
            margin-left: 8px;
        }

        .aggregated-note {
            font-size: 12px;
            color: #28a745;
            font-style: italic;
            margin-top: 5px;
        }

        .opp-code-header {
            margin: 5px 0 10px 0;
            font-size: 14px;
        }

        .code-highlight {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .code-legal {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .modifier-badge {
            display: inline-block;
            background: #ffc107;
            color: #212529;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
            cursor: help;
        }

        .modifier-badge:hover {
            background: #e0a800;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DermBill AI</h1>
            <p>Dermatology Billing Optimization System</p>
        </header>

        <div class="main-card">
            <div class="input-section">
                <label for="clinical-note">Paste Clinical Note:</label>
                <textarea id="clinical-note" placeholder="Enter the clinical note here...

Example:
Patient presents for follow-up of plaque psoriasis on bilateral elbows and knees.
Current treatment: clobetasol cream BID.
Exam: Thick plaques on bilateral elbows, knees. Nail exam reveals pitting on 8 nails.
Performed nail debridement.
Plan: Continue current therapy. Return in 3 months."></textarea>
                <div class="button-row">
                    <button class="btn-primary" id="analyze-btn" onclick="analyzeNote()">
                        Analyze Note
                    </button>
                    <button class="btn-secondary" onclick="loadExample()">
                        Load Example
                    </button>
                    <button class="btn-secondary" onclick="clearAll()">
                        Clear
                    </button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="entities">1. Entities</button>
                <button class="tab" data-tab="current">2. Current Billing</button>
                <button class="tab" data-tab="enhancements">3. Enhancements</button>
                <button class="tab" data-tab="opportunities">4. Opportunities</button>
            </div>

            <div class="results-section">
                <div id="placeholder" class="placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>Enter a clinical note and click "Analyze Note" to get billing optimization recommendations.</p>
                </div>

                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Analyzing clinical note...</p>
                </div>

                <div id="error" class="error-message" style="display: none;"></div>

                <div id="results" style="display: none;">
                    <div id="tab-entities" class="tab-content active"></div>
                    <div id="tab-current" class="tab-content"></div>
                    <div id="tab-enhancements" class="tab-content"></div>
                    <div id="tab-opportunities" class="tab-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        function loadExample() {
            document.getElementById('clinical-note').value = `Patient presents for follow-up of plaque psoriasis on bilateral elbows and knees.
Current treatment: clobetasol cream BID, not well controlled.

HPI: 45-year-old male with 10-year history of plaque psoriasis. Reports morning stiffness lasting 30 minutes. Denies joint swelling.

Exam:
- Thick erythematous plaques on bilateral elbows (4x3 cm each)
- Similar plaques on bilateral knees (5x4 cm each)
- Nail exam: pitting on 8 nails with subungual debris
- BSA approximately 5%

Assessment: Plaque psoriasis, moderate severity, with nail involvement

Plan:
1. Nail debridement performed today
2. IL triamcinolone 10mg/mL injected into 4 thick plaques (bilateral elbows)
3. Discussed biologic therapy options given inadequate response to topicals
4. Return in 6 weeks to reassess and potentially initiate systemic therapy`;
        }

        // Global storage for analysis results
        let currentAnalysisData = null;

        // Code family definitions for count-based aggregation
        const CODE_FAMILIES = {
            'il_injection': {
                name: 'IL Injections',
                tiers: [
                    { min: 1, max: 7, code: '11900', wRVU: 0.51, desc: 'IL injection 1-7 lesions' },
                    { min: 8, max: 999, code: '11901', wRVU: 0.78, desc: 'IL injection 8+ lesions' }
                ],
                patterns: ['11900', '11901'],
                mutuallyExclusive: true,
                mue: 1
            },
            'ak_destruction': {
                name: 'AK Destruction',
                tiers: [
                    { min: 1, max: 1, code: '17000', wRVU: 0.61, desc: 'AK destruction first lesion' },
                    { min: 2, max: 14, code: '17000+17003', wRVU: null, desc: 'AK destruction 2-14', perUnit: 0.09, baseWRVU: 0.61 },
                    { min: 15, max: 999, code: '17004', wRVU: 2.59, desc: 'AK destruction 15+' }
                ],
                patterns: ['17000', '17003', '17004'],
                mutuallyExclusive: true,
                mue: 1
            },
            'benign_destruction': {
                name: 'Benign Lesion Destruction',
                tiers: [
                    { min: 1, max: 14, code: '17110', wRVU: 0.68, desc: 'Benign destruction 1-14' },
                    { min: 15, max: 999, code: '17111', wRVU: 0.95, desc: 'Benign destruction 15+' }
                ],
                patterns: ['17110', '17111'],
                mutuallyExclusive: true,
                mue: 1
            },
            'nail_debridement': {
                name: 'Nail Debridement',
                tiers: [
                    { min: 1, max: 5, code: '11720', wRVU: 0.31, desc: 'Nail debridement 1-5' },
                    { min: 6, max: 999, code: '11721', wRVU: 0.53, desc: 'Nail debridement 6+' }
                ],
                patterns: ['11720', '11721'],
                mutuallyExclusive: true,
                mue: 1
            },
            'id_abscess': {
                name: 'I&D Abscess',
                tiers: [
                    { min: 1, max: 1, code: '10060', wRVU: 1.19, desc: 'I&D simple abscess' },
                    { min: 2, max: 999, code: '10061', wRVU: 2.39, desc: 'I&D complicated abscess' }
                ],
                patterns: ['10060', '10061'],
                mutuallyExclusive: true,
                mue: 1
            },
            'em_established': {
                name: 'E/M Established',
                tiers: [
                    { min: 1, max: 1, code: '99211', wRVU: 0.18, desc: 'E/M minimal' },
                    { min: 2, max: 2, code: '99212', wRVU: 0.70, desc: 'E/M straightforward' },
                    { min: 3, max: 3, code: '99213', wRVU: 1.30, desc: 'E/M low complexity' },
                    { min: 4, max: 4, code: '99214', wRVU: 1.92, desc: 'E/M moderate complexity' },
                    { min: 5, max: 5, code: '99215', wRVU: 2.80, desc: 'E/M high complexity' }
                ],
                patterns: ['99211', '99212', '99213', '99214', '99215'],
                mutuallyExclusive: true,
                mue: 2
            }
        };

        // MUE (Medically Unlikely Edits) data
        const MUE_DATA = {
            // E/M codes
            '99213': { mue: 2, wRVU: 1.30 },
            '99214': { mue: 2, wRVU: 1.92 },
            '99215': { mue: 1, wRVU: 2.80 },
            'G2211': { mue: 1, wRVU: 0.33, addOn: true },
            // Procedures
            '11720': { mue: 1, wRVU: 0.31, family: 'nail_debridement' },
            '11721': { mue: 1, wRVU: 0.53, family: 'nail_debridement' },
            '11900': { mue: 1, wRVU: 0.51, family: 'il_injection' },
            '11901': { mue: 1, wRVU: 0.78, family: 'il_injection' },
            '10060': { mue: 1, wRVU: 1.19, family: 'id_abscess' },
            '10061': { mue: 1, wRVU: 2.39, family: 'id_abscess' },
            '10040': { mue: 1, wRVU: 0.89 },
            '17360': { mue: 1, wRVU: 1.42 },  // Chemical exfoliation
            '17000': { mue: 1, wRVU: 0.59, family: 'ak_destruction' },
            '17003': { mue: 13, wRVU: 0.04, addOn: true },
            '17004': { mue: 1, wRVU: 1.34, family: 'ak_destruction' },
            '17110': { mue: 1, wRVU: 0.68, family: 'benign_destruction' },
            '17111': { mue: 1, wRVU: 0.95, family: 'benign_destruction' },
            '11102': { mue: 1, wRVU: 0.64 },
            '11103': { mue: 14, wRVU: 0.37, addOn: true },
            '11104': { mue: 1, wRVU: 0.81 },
            '11105': { mue: 9, wRVU: 0.44, addOn: true },
            // Mohs surgery - wRVU from CPT_Master_Reference.xlsx
            '17311': { mue: 2, wRVU: 6.05 },   // Stage 1, H/N/HF/G, ≤5 blocks (max 2 lesions/visit)
            '17312': { mue: 20, wRVU: 3.22, addOn: true },  // Additional stage, H/N/HF/G
            '17313': { mue: 8, wRVU: 5.42 },   // Stage 1, trunk/arms/legs
            '17314': { mue: 40, wRVU: 2.98, addOn: true },  // Additional stage, T/A/L
            '17315': { mue: 20, wRVU: 0.85, addOn: true },  // Additional block
            // Repairs - intermediate (wRVU from CPT_Master_Reference.xlsx)
            '12031': { mue: 3, wRVU: 1.95 },  // Scalp/trunk 2.5cm or less
            '12032': { mue: 3, wRVU: 2.46 },  // Scalp/trunk 2.6-7.5cm
            '12034': { mue: 3, wRVU: 2.90 },  // Scalp/trunk 7.6-12.5cm
            '12051': { mue: 3, wRVU: 2.27 },  // Face 2.5cm or less
            '12052': { mue: 3, wRVU: 2.80 },  // Face 2.6-5.0cm
            '12053': { mue: 3, wRVU: 3.09 },  // Face 5.1-7.5cm
            // Repairs - complex
            '13131': { mue: 3, wRVU: 3.64 },  // Complex, face 1.1-2.5cm
            '13132': { mue: 3, wRVU: 4.66 },  // Complex, face 2.6-7.5cm
            // Flaps
            '14060': { mue: 3, wRVU: 9.00 },  // Tissue transfer, face ≤10 sq cm
            '14061': { mue: 3, wRVU: 11.19 }, // Tissue transfer, face 10.1-30 sq cm
            '15260': { mue: 3, wRVU: 11.35 }, // Full thickness graft, nose/eyelids ≤20 sq cm
        };

        // Helper to sanitize codes: filter non-billable and correct wRVU from MUE_DATA
        function sanitizeBillingCodes(codes) {
            if (!codes || !Array.isArray(codes)) return [];
            return codes
                .filter(c => {
                    // Filter out non-billable codes
                    const codeUpper = (c.code || '').toUpperCase().trim();
                    return codeUpper !== 'LEGAL' && codeUpper !== 'COUNT_CLARIFY' && codeUpper !== '';
                })
                .map(c => {
                    // Correct wRVU from MUE_DATA if available
                    const mueData = MUE_DATA[c.code];
                    return {
                        ...c,
                        wRVU: mueData?.wRVU ?? c.wRVU ?? 0
                    };
                });
        }

        // MUE enforcement: check codes against limits, cap at MUE, return warnings
        // Returns: { codes: [...with mueExceeded flag], warnings: [...] }
        function applyMUELimits(codes) {
            if (!codes || !Array.isArray(codes)) return { codes: [], warnings: [] };

            const warnings = [];
            const codeCount = {}; // Track how many times each code appears

            // Count occurrences
            codes.forEach(c => {
                const code = c.code;
                codeCount[code] = (codeCount[code] || 0) + (c.units || 1);
            });

            // Check against MUE and flag
            const processedCodes = codes.map(c => {
                const code = c.code;
                const mueData = MUE_DATA[code];
                const mueLimit = mueData?.mue;
                const totalUnits = codeCount[code] || 1;

                if (mueLimit && totalUnits > mueLimit) {
                    // Exceeds MUE - flag it
                    warnings.push({
                        code: code,
                        requested: totalUnits,
                        limit: mueLimit,
                        message: `${code} exceeds MUE limit: ${totalUnits} requested, max ${mueLimit}/visit. Only ${mueLimit} will be reimbursed.`
                    });
                    return {
                        ...c,
                        mueExceeded: true,
                        mueLimit: mueLimit,
                        requestedUnits: totalUnits
                    };
                }
                return c;
            });

            return { codes: processedCodes, warnings };
        }

        // Build complete billing codes by merging baseline + changes
        // Handles: code upgrades, MUE limits, mutually exclusive families
        function buildCompleteBillingCodes(baselineCodes, additionalCodes) {
            // Sanitize inputs first - filter non-billable and correct wRVU
            baselineCodes = sanitizeBillingCodes(baselineCodes);
            additionalCodes = sanitizeBillingCodes(additionalCodes);
            const result = new Map(); // code -> {code, description, wRVU, ...}
            const familyBest = new Map(); // family -> best code in that family

            // Helper to get family for a code
            function getFamily(code) {
                if (MUE_DATA[code]?.family) return MUE_DATA[code].family;
                // Check E/M
                if (/^99\d{3}$/.test(code)) return 'em_established';
                return null;
            }

            // Helper to compare codes in same family (higher wRVU wins)
            function isBetterCode(newCode, existingCode, family) {
                const newWRVU = MUE_DATA[newCode]?.wRVU || 0;
                const existingWRVU = MUE_DATA[existingCode]?.wRVU || 0;
                return newWRVU > existingWRVU;
            }

            // Process baseline codes first
            (baselineCodes || []).forEach(c => {
                const code = c.code;
                const family = getFamily(code);

                if (family) {
                    if (!familyBest.has(family) || isBetterCode(code, familyBest.get(family).code, family)) {
                        familyBest.set(family, { ...c, fromBaseline: true });
                    }
                } else {
                    result.set(code, { ...c, fromBaseline: true });
                }
            });

            // Process additional codes (upgrades/opportunities)
            (additionalCodes || []).forEach(c => {
                const code = c.code;
                const family = getFamily(code);

                if (family) {
                    // Mutually exclusive - keep the better one
                    if (!familyBest.has(family) || isBetterCode(code, familyBest.get(family).code, family)) {
                        familyBest.set(family, { ...c, upgraded: familyBest.has(family) });
                    }
                } else if (MUE_DATA[code]?.addOn) {
                    // Add-on codes can be added (respect MUE)
                    if (!result.has(code)) {
                        result.set(code, c);
                    }
                } else {
                    // Regular codes - add if not already present
                    if (!result.has(code)) {
                        result.set(code, c);
                    }
                }
            });

            // Merge family bests into result
            familyBest.forEach((codeData, family) => {
                result.set(codeData.code, codeData);
            });

            return Array.from(result.values());
        }

        // Detect code family from a code string
        function detectCodeFamily(code) {
            if (!code) return null;
            for (const [familyId, family] of Object.entries(CODE_FAMILIES)) {
                for (const pattern of family.patterns) {
                    if (code.includes(pattern)) return familyId;
                }
            }
            return null;
        }

        // Calculate wRVU for a code family given count
        function calculateFamilyWRVU(familyId, count) {
            const family = CODE_FAMILIES[familyId];
            if (!family) return { code: null, wRVU: 0, desc: '' };

            for (const tier of family.tiers) {
                if (count >= tier.min && count <= tier.max) {
                    if (tier.perUnit) {
                        // Count-based like AK: 17000 + (count-1) * 17003
                        const wRVU = tier.baseWRVU + (count - 1) * tier.perUnit;
                        return { code: `17000+17003x${count-1}`, wRVU, desc: `AK destruction ${count} lesions` };
                    }
                    return { code: tier.code, wRVU: tier.wRVU, desc: tier.desc };
                }
            }
            return { code: null, wRVU: 0, desc: '' };
        }

        // Apply appropriate modifiers to billing codes
        // Strategy: Apply modifiers to LOWEST value codes first to minimize payment reduction
        function applyModifiers(codes) {
            if (!codes || codes.length === 0) return codes;

            // Identify E/M codes and procedure codes
            const emCodes = codes.filter(c => /^99\d{3}$/.test(c.code));
            const procedureCodes = codes.filter(c => !/^99\d{3}$/.test(c.code) && !/^G\d{4}$/.test(c.code));
            const addOnCodes = codes.filter(c => /^G\d{4}$/.test(c.code));

            // Apply -25 to E/M if there are procedures
            if (emCodes.length > 0 && procedureCodes.length > 0) {
                emCodes.forEach(em => {
                    em.modifier = '-25';
                    em.modifierReason = 'Separate E/M with same-day procedure';
                });
            }

            // Helper to extract anatomic site from description
            function extractSite(desc) {
                if (!desc) return 'general';
                const d = desc.toLowerCase();
                // Check for laterality first
                if (d.includes('left') || d.includes(' l ') || d.includes('(l)')) return 'left';
                if (d.includes('right') || d.includes(' r ') || d.includes('(r)')) return 'right';
                if (d.includes('bilateral')) return 'bilateral';
                // Check for body regions
                if (d.includes('face') || d.includes('forehead') || d.includes('cheek') || d.includes('nose') || d.includes('lip') || d.includes('eyelid')) return 'face';
                if (d.includes('scalp') || d.includes('head')) return 'scalp';
                if (d.includes('neck')) return 'neck';
                if (d.includes('trunk') || d.includes('chest') || d.includes('back') || d.includes('abdomen')) return 'trunk';
                if (d.includes('arm') || d.includes('forearm') || d.includes('elbow') || d.includes('wrist')) return 'arm';
                if (d.includes('hand') || d.includes('finger')) return 'hand';
                if (d.includes('leg') || d.includes('thigh') || d.includes('knee') || d.includes('ankle')) return 'leg';
                if (d.includes('foot') || d.includes('toe')) return 'foot';
                if (d.includes('nail')) return 'nail';
                if (d.includes('genital')) return 'genital';
                return 'general';
            }

            // Helper to get procedure type from code
            function getProcedureType(code) {
                if (!code) return 'other';
                if (code.startsWith('117')) return 'nail';
                if (code.startsWith('119')) return 'injection';
                if (code.startsWith('170') || code.startsWith('171')) return 'destruction';
                if (code.startsWith('111')) return 'biopsy';
                if (code.startsWith('114') || code.startsWith('116')) return 'excision';
                if (code.startsWith('100')) return 'surgery';
                if (code.startsWith('173')) return 'peel';
                if (code.startsWith('540') || code.startsWith('565')) return 'genital';
                return 'other';
            }

            // STEP 1: Handle bilateral procedures (-50 or -LT/-RT)
            // Group by procedure code to find duplicates
            const codeGroups = {};
            procedureCodes.forEach((proc, idx) => {
                if (!codeGroups[proc.code]) codeGroups[proc.code] = [];
                codeGroups[proc.code].push({ proc, idx });
            });

            // Check for bilateral indicators
            Object.entries(codeGroups).forEach(([code, items]) => {
                if (items.length === 2) {
                    // Two of the same code - check if left/right
                    const sites = items.map(i => extractSite(i.proc.description));
                    if ((sites[0] === 'left' && sites[1] === 'right') ||
                        (sites[0] === 'right' && sites[1] === 'left')) {
                        // Apply -LT and -RT
                        items.forEach(item => {
                            const site = extractSite(item.proc.description);
                            if (site === 'left') {
                                item.proc.modifier = '-LT';
                                item.proc.modifierReason = 'Left side';
                            } else if (site === 'right') {
                                item.proc.modifier = '-RT';
                                item.proc.modifierReason = 'Right side';
                            }
                        });
                    }
                } else if (items.length === 1) {
                    // Single code - check if bilateral in description
                    const desc = items[0].proc.description?.toLowerCase() || '';
                    if (desc.includes('bilateral')) {
                        items[0].proc.modifier = '-50';
                        items[0].proc.modifierReason = 'Bilateral procedure';
                    }
                }
            });

            // STEP 2: Apply -XS or -59 to distinct procedures
            // Group by anatomic site (from description) AND procedure type
            const siteTypeGroups = {};
            procedureCodes.forEach((proc, idx) => {
                const site = extractSite(proc.description);
                const procType = getProcedureType(proc.code);
                const key = `${site}:${procType}`;

                if (!siteTypeGroups[key]) siteTypeGroups[key] = [];
                siteTypeGroups[key].push({ proc, idx, wRVU: proc.wRVU || 0, site, procType });
            });

            // Determine which modifier to use
            // -XS: Different anatomic structure (preferred in derm)
            // -59: Same structure but distinct procedure (fallback)
            const groupKeys = Object.keys(siteTypeGroups);

            if (groupKeys.length > 1) {
                // Multiple distinct groups - flatten and sort by wRVU descending
                let allProcs = [];
                groupKeys.forEach(key => {
                    siteTypeGroups[key].forEach(item => {
                        allProcs.push({ ...item, groupKey: key });
                    });
                });

                // Sort by wRVU DESCENDING - highest value first gets NO modifier
                allProcs.sort((a, b) => (b.wRVU || 0) - (a.wRVU || 0));

                // Track sites we've seen to determine XS vs 59
                const seenSites = new Set();
                let isFirst = true;

                allProcs.forEach(item => {
                    if (item.proc.modifier) return; // Already has modifier (bilateral)

                    if (isFirst) {
                        // Highest value procedure - no additional modifier (primary)
                        seenSites.add(item.site);
                        isFirst = false;
                    } else {
                        // Determine appropriate modifier
                        if (!seenSites.has(item.site) || item.site === 'general') {
                            // Different site - use -XS
                            item.proc.modifier = '-XS';
                            item.proc.modifierReason = 'Separate anatomic structure';
                            seenSites.add(item.site);
                        } else {
                            // Same site, different procedure type - use -59
                            item.proc.modifier = '-59';
                            item.proc.modifierReason = 'Distinct procedural service';
                        }
                    }
                });
            }

            // Combine back
            return [...emCodes, ...procedureCodes, ...addOnCodes];
        }

        function clearAll() {
            document.getElementById('clinical-note').value = '';
            document.getElementById('placeholder').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            currentAnalysisData = null;
        }

        async function analyzeNote() {
            const note = document.getElementById('clinical-note').value.trim();
            if (!note) {
                alert('Please enter a clinical note');
                return;
            }

            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('analyze-btn').disabled = true;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 minute timeout

                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note: note }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                const text = await response.text();
                if (!text) {
                    throw new Error('Empty response from server - the request may have timed out. Try using a faster model (claude-sonnet-4-20250514).');
                }

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error('Invalid JSON response: ' + text.substring(0, 200));
                }

                if (!response.ok) {
                    throw new Error(data.detail || 'Analysis failed');
                }

                currentAnalysisData = data;
                displayResults(data);
            } catch (err) {
                if (err.name === 'AbortError') {
                    document.getElementById('error').textContent = 'Error: Request timed out after 3 minutes. Try using a faster model (claude-sonnet-4-20250514).';
                } else {
                    document.getElementById('error').textContent = 'Error: ' + err.message;
                }
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('analyze-btn').disabled = false;
            }
        }

        function displayResults(data) {
            // Entities tab
            const entitiesHtml = `
                <h3>Extracted Entities</h3>
                <div class="entities-grid">
                    <div class="entity-box">
                        <h4>Diagnoses</h4>
                        <ul>${data.entities.diagnoses.map(d => `<li>${d}</li>`).join('') || '<li>None found</li>'}</ul>
                    </div>
                    <div class="entity-box">
                        <h4>Procedures</h4>
                        <ul>${data.entities.procedures.map(p => `<li>${p}</li>`).join('') || '<li>None found</li>'}</ul>
                    </div>
                    <div class="entity-box">
                        <h4>Anatomic Sites</h4>
                        <ul>${data.entities.anatomic_sites.map(s => `<li>${s}</li>`).join('') || '<li>None found</li>'}</ul>
                    </div>
                    <div class="entity-box">
                        <h4>Medications</h4>
                        <ul>${data.entities.medications.map(m => `<li>${m}</li>`).join('') || '<li>None found</li>'}</ul>
                    </div>
                </div>
                ${data.entities.measurements.length ? `
                    <div class="entity-box" style="margin-top: 15px;">
                        <h4>Measurements</h4>
                        <ul>${data.entities.measurements.map(m => `<li>${m.type}: ${m.value} ${m.unit || ''}</li>`).join('')}</ul>
                    </div>
                ` : ''}
            `;
            document.getElementById('tab-entities').innerHTML = entitiesHtml;

            // Current billing tab
            const currentBilling = data.current_billing;
            // Sanitize codes early: filter non-billable and correct wRVU from MUE_DATA
            const sanitizedCurrentCodes = sanitizeBillingCodes(currentBilling.codes);
            const correctedCurrentTotalWRVU = sanitizedCurrentCodes.reduce((sum, c) => sum + (c.wRVU || 0), 0);

            let currentHtml = `
                <div class="summary-box">
                    <h3>Current Maximum Billing</h3>
                    <div class="summary-stats">
                        <div class="stat">
                            <div class="stat-value">${correctedCurrentTotalWRVU.toFixed(2)}</div>
                            <div class="stat-label">Total wRVU</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${sanitizedCurrentCodes.length}</div>
                            <div class="stat-label">Billable Codes</div>
                        </div>
                    </div>
                </div>
            `;

            if (sanitizedCurrentCodes.length) {
                const currentCodesWithModifiers = applyModifiers(sanitizedCurrentCodes);

                currentHtml += `
                    <table class="billing-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Mod</th>
                                <th>Description</th>
                                <th>wRVU</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentCodesWithModifiers.map(c => {
                                const modifierDisplay = c.modifier ?
                                    `<span class="modifier-badge" title="${c.modifierReason || ''}">${c.modifier}</span>` :
                                    '-';
                                return `
                                <tr>
                                    <td><strong>${c.code}</strong></td>
                                    <td>${modifierDisplay}</td>
                                    <td>${c.description}</td>
                                    <td><span class="wrvu-badge">${(c.wRVU || 0).toFixed(2)}</span></td>
                                    <td class="${c.status === 'supported' ? 'status-supported' : 'status-missing'}">${c.status}</td>
                                </tr>
                            `}).join('')}
                            <tr class="total-row">
                                <td colspan="3"><strong>TOTAL</strong></td>
                                <td><span class="wrvu-badge">${correctedCurrentTotalWRVU.toFixed(2)}</span></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }

            if (currentBilling.documentation_gaps.length) {
                currentHtml += `
                    <div class="gap-list">
                        <h4>Documentation Gaps</h4>
                        <ul>${currentBilling.documentation_gaps.map(g => `<li>${g}</li>`).join('')}</ul>
                    </div>
                `;
            }
            document.getElementById('tab-current').innerHTML = currentHtml;

            // Enhancements tab
            const enhancements = data.documentation_enhancements;
            let enhHtml = `
                <div class="summary-box">
                    <h3>Documentation Enhancements</h3>
                    <div class="summary-stats">
                        <div class="stat">
                            <div class="stat-value" id="enh-delta-display">+${enhancements.improvement.toFixed(2)}</div>
                            <div class="stat-label">Additional wRVU (Selected)</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="enh-total-display">${enhancements.enhanced_total_wRVU.toFixed(2)}</div>
                            <div class="stat-label">Total wRVU (with Selected)</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${currentBilling.total_wRVU.toFixed(2)}</div>
                            <div class="stat-label">Baseline wRVU</div>
                        </div>
                    </div>
                </div>
            `;

            // Build enhanced billing codes table for Step 3
            // Shows COMPLETE billable codes (baseline + selected enhancements) for EMR entry
            enhHtml += `
                <h4 style="margin-top: 20px;">Complete Billing Codes (for EMR Entry)</h4>
                <table class="billing-table" id="enh-billing-table">
                    <thead>
                        <tr><th>Code</th><th>Mod</th><th>Description</th><th>wRVU</th></tr>
                    </thead>
                    <tbody id="enh-billing-tbody">
                    </tbody>
                </table>
            `;

            if (enhancements.enhancements.length) {
                enhHtml += '<h4 style="margin-top: 20px;">Enhancement Recommendations</h4>';
                enhHtml += '<div id="enhancement-list">';
                enhHtml += enhancements.enhancements.map((e, idx) => {
                    // Check if this is a count clarification card
                    const isCountClarify = e.priority === 'count_clarification' || e.enhanced_code === 'COUNT_CLARIFY';
                    const countFamily = e.count_family || null;
                    const defaultCount = e.default_count || 1;

                    if (isCountClarify && countFamily) {
                        // Render count clarification card with input
                        const family = CODE_FAMILIES[countFamily];
                        const familyName = family ? family.name : countFamily;
                        return `
                            <div class="enhancement-card count_clarification" style="border-left-color: #17a2b8;">
                                <div style="display: flex; align-items: flex-start; gap: 10px;">
                                    <input type="checkbox" class="enhancement-checkbox count-clarify-checkbox"
                                           data-index="${idx}" data-family="${countFamily}"
                                           checked style="margin-top: 5px; transform: scale(1.3);">
                                    <div style="flex: 1;">
                                        <span class="category-badge" style="background: #17a2b8; color: white;">COUNT NEEDED</span>
                                        <h4 style="margin: 5px 0;">${e.issue}</h4>
                                        <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0;">
                                            <strong>⚠️ Action Required:</strong> The note does not specify the count. Please enter the actual number performed.
                                        </p>
                                        <div class="count-input-group" data-family="${countFamily}">
                                            <label>Actual count:</label>
                                            <input type="number" class="count-input count-clarify-input"
                                                   data-enh-index="${idx}"
                                                   data-family="${countFamily}"
                                                   min="1" max="99" value="${defaultCount}">
                                            <span class="code-family-badge">${familyName}</span>
                                            <span id="count-clarify-result-${idx}" style="margin-left: 10px; font-weight: 600; color: #28a745;"></span>
                                        </div>
                                        <p style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                            Enter the count to calculate the correct billing code. Billing will update automatically.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // Regular enhancement card (non-count-clarify)
                    // Use MUE_DATA wRVU if available
                    const currentWRVU = e.current_code && MUE_DATA[e.current_code] ? MUE_DATA[e.current_code].wRVU : e.current_wRVU;
                    const enhancedWRVU = e.enhanced_code && MUE_DATA[e.enhanced_code] ? MUE_DATA[e.enhanced_code].wRVU : e.enhanced_wRVU;
                    const deltaWRVU = enhancedWRVU - currentWRVU;

                    return `
                        <div class="enhancement-card ${e.priority}">
                            <label class="checkbox-label" style="display: flex; align-items: flex-start; gap: 10px;">
                                <input type="checkbox" class="enhancement-checkbox" data-index="${idx}" checked style="margin-top: 5px; transform: scale(1.3);">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0;">${e.issue}</h4>
                                    ${e.current_code ? `<p>Current: <strong>${e.current_code}</strong> (${currentWRVU.toFixed(2)} wRVU)</p>` : ''}
                                    ${e.enhanced_code && e.enhanced_code !== 'LEGAL' ? `<p>Enhanced: <strong>${e.enhanced_code}</strong> (${enhancedWRVU.toFixed(2)} wRVU)</p>` : ''}
                                    ${e.enhanced_code === 'LEGAL' ? `<p><strong>Type:</strong> <span class="code-legal">LEGAL</span> (Liability Protection)</p>` : ''}
                                    ${deltaWRVU > 0 ? `<p class="delta-positive">+${deltaWRVU.toFixed(2)} wRVU improvement</p>` : ''}
                                    <div class="suggested-text">${e.suggested_addition}</div>
                                </div>
                            </label>
                        </div>
                    `;
                }).join('');
                enhHtml += '</div>';
            } else {
                enhHtml += '<p>No documentation enhancements identified.</p>';
            }

            // Add regenerate button if there are enhancements
            if (enhancements.enhancements.length) {
                enhHtml += `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <button class="btn-primary" onclick="regenerateNote('enhancements')" id="regenerate-enh-btn">
                            Regenerate Note with Selected Enhancements
                        </button>
                        <span id="regenerate-enh-status" style="margin-left: 10px; color: #666;"></span>
                    </div>
                `;
            }

            enhHtml += `
                <h3 style="margin-top: 30px;">Optimized Note</h3>
                <div class="optimized-note" id="optimized-note-enhancements">${enhancements.optimized_note || 'No optimized note available'}</div>
                <button class="btn-secondary copy-btn" onclick="copyToClipboard(document.getElementById('optimized-note-enhancements').textContent)">Copy to Clipboard</button>
            `;
            document.getElementById('tab-enhancements').innerHTML = enhHtml;

            // Opportunities tab
            const opportunities = data.future_opportunities;
            const baselineWRVU = currentBilling.total_wRVU;

            let oppHtml = `
                <div class="summary-box">
                    <h3>Intra-Encounter Opportunities</h3>
                    <div class="summary-stats">
                        <div class="stat">
                            <div class="stat-value" id="opp-delta-display">+${opportunities.total_potential_additional_wRVU.toFixed(2)}</div>
                            <div class="stat-label">Additional wRVU (Selected)</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="opp-total-display">${(baselineWRVU + opportunities.total_potential_additional_wRVU).toFixed(2)}</div>
                            <div class="stat-label">Total wRVU (with Selected)</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${baselineWRVU.toFixed(2)}</div>
                            <div class="stat-label">Baseline wRVU</div>
                        </div>
                    </div>
                </div>
            `;

            // Build dynamic billing codes table for Step 4
            // Shows COMPLETE billable codes (baseline + enhancements + opportunities) for EMR entry
            oppHtml += `
                <h4 style="margin-top: 20px;">Complete Billing Codes (for EMR Entry)</h4>
                <table class="billing-table" id="opp-billing-table">
                    <thead>
                        <tr><th>Code</th><th>Mod</th><th>Description</th><th>wRVU</th></tr>
                    </thead>
                    <tbody id="opp-billing-tbody">
                    </tbody>
                </table>
            `;

            if (opportunities.opportunities.length) {
                oppHtml += '<h4 style="margin-top: 20px;">Opportunity Recommendations</h4>';
                oppHtml += '<div id="opportunity-list">';
                oppHtml += opportunities.opportunities.map((o, idx) => {
                    let codeDisplay = '';

                    // Detect if this is a count-based code family
                    let detectedFamily = null;
                    if (o.potential_code) {
                        detectedFamily = detectCodeFamily(o.potential_code.code);
                    } else if (o.code_options && o.code_options.length > 0) {
                        detectedFamily = detectCodeFamily(o.code_options[0].code);
                    }

                    // Categories that should NOT show count input
                    const noCountCategories = ['visit_level', 'comorbidity', 'medicolegal'];
                    const isNoCountCategory = noCountCategories.includes(o.category);

                    // E/M family shouldn't show count input either
                    const isEmFamily = detectedFamily === 'em_established';

                    // Show code prominently at top (like enhancements)
                    let codeHeader = '';
                    if (o.potential_code && o.potential_code.code) {
                        const code = o.potential_code.code;
                        const wRVU = o.potential_code.wRVU || 0;
                        if (code === 'LEGAL') {
                            codeHeader = `<p class="opp-code-header"><strong>Type:</strong> <span class="code-legal">LEGAL</span> (Liability Protection)</p>`;
                        } else {
                            codeHeader = `<p class="opp-code-header"><strong>Code:</strong> <span class="code-highlight">${code}</span> (${wRVU.toFixed(2)} wRVU)</p>`;
                        }
                    }

                    // If it's a count-based family AND not a no-count category, render count input
                    if (detectedFamily && CODE_FAMILIES[detectedFamily] && !isNoCountCategory && !isEmFamily) {
                        const family = CODE_FAMILIES[detectedFamily];
                        // Extract default count from potential_code description or code_options
                        let defaultCount = 1;
                        if (o.potential_code && o.potential_code.description) {
                            const countMatch = o.potential_code.description.match(/(\d+)\s*(lesion|nail|site)/i);
                            if (countMatch) defaultCount = parseInt(countMatch[1]);
                        }
                        codeDisplay = `
                            ${codeHeader}
                            <div class="count-input-group" data-family="${detectedFamily}">
                                <label>Number of lesions/sites:</label>
                                <input type="number" class="count-input"
                                       data-opp-index="${idx}"
                                       data-family="${detectedFamily}"
                                       min="1" max="99" value="${defaultCount}">
                                <span class="code-family-badge">${family.name}</span>
                            </div>
                            <p class="aggregated-note">Counts from same family are aggregated to determine final tier</p>
                        `;
                    }
                    // Check if this opportunity has tiered code options (non-count-based)
                    else if (o.code_options && o.code_options.length > 0) {
                        codeDisplay = `
                            <div class="tier-options">
                                <strong>Select Tier:</strong>
                                ${o.code_options.map((co, tierIdx) => `
                                    <label>
                                        <input type="radio" name="tier-${idx}" class="tier-radio"
                                               data-opp-index="${idx}" data-tier-index="${tierIdx}"
                                               data-code="${co.code}" data-wrvu="${co.wRVU}"
                                               data-desc="${co.description}"
                                               ${tierIdx === 0 ? 'checked' : ''}>
                                        <span class="tier-code">${co.code}</span>
                                        <span class="tier-threshold">(${co.threshold})</span>
                                        <span class="tier-wrvu">+${co.wRVU.toFixed(2)} wRVU</span>
                                    </label>
                                `).join('')}
                            </div>
                        `;
                    } else if (o.potential_code) {
                        // For simple code display (E/M, medicolegal, comorbidity)
                        codeDisplay = codeHeader;
                    }

                    return `
                        <div class="opportunity-card" data-family="${detectedFamily || ''}">
                            <label class="checkbox-label" style="display: flex; align-items: flex-start; gap: 10px;">
                                <input type="checkbox" class="opportunity-checkbox" data-index="${idx}" data-family="${detectedFamily || ''}" checked style="margin-top: 5px; transform: scale(1.3);">
                                <div style="flex: 1;">
                                    <span class="category-badge category-${o.category}">${o.category.toUpperCase()}</span>
                                    <h4 style="margin: 5px 0;">${o.finding}</h4>
                                    ${codeDisplay}
                                    <div class="suggested-text">${o.action}</div>
                                </div>
                            </label>
                        </div>
                    `;
                }).join('');
                oppHtml += '</div>';
            } else {
                oppHtml += '<p>No additional opportunities identified.</p>';
            }

            // Add regenerate button if there are opportunities
            if (opportunities.opportunities.length) {
                oppHtml += `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <button class="btn-primary" onclick="regenerateNote('opportunities')" id="regenerate-opp-btn">
                            Regenerate Note with Selected Opportunities
                        </button>
                        <span id="regenerate-opp-status" style="margin-left: 10px; color: #666;"></span>
                    </div>
                `;
            }

            oppHtml += `
                <h3 style="margin-top: 30px;">Optimized Note (All Opportunities)</h3>
                <div class="optimized-note" id="optimized-note-opportunities">${opportunities.optimized_note || 'No optimized note available'}</div>
                <button class="btn-secondary copy-btn" onclick="copyToClipboard(document.getElementById('optimized-note-opportunities').textContent)">Copy to Clipboard</button>
            `;

            oppHtml += `<div class="compliance-notice">${data.compliance_notice}</div>`;
            document.getElementById('tab-opportunities').innerHTML = oppHtml;

            document.getElementById('results').style.display = 'block';

            // Set up event listeners for dynamic totals
            setupEnhancementListeners();
            updateEnhancementTotals();
            setupOpportunityListeners();
            updateOpportunityTotals();
        }

        function setupEnhancementListeners() {
            document.querySelectorAll('.enhancement-checkbox').forEach(cb => {
                cb.addEventListener('change', updateEnhancementTotals);
            });
            // Listen for count clarification input changes
            document.querySelectorAll('.count-clarify-input').forEach(input => {
                input.addEventListener('input', updateEnhancementTotals);
                input.addEventListener('change', updateEnhancementTotals);
            });
        }

        function updateEnhancementTotals() {
            if (!currentAnalysisData) return;

            const currentBilling = currentAnalysisData.current_billing;
            const enhancements = currentAnalysisData.documentation_enhancements.enhancements;
            const baselineCodes = currentBilling.codes || [];
            const baselineWRVU = currentBilling.total_wRVU;

            // Helper to extract clean CPT code
            function cleanCode(code) {
                if (!code) return null;
                const match = code.match(/^(99\d{3}|G\d{4}|\d{5})/);
                return match ? match[1] : code.trim();
            }

            // Collect enhancement codes (upgrades and additions)
            let enhancementCodes = [];
            // Track family counts from count-clarification cards
            let familyCounts = {};

            enhancements.forEach((e, idx) => {
                const checkbox = document.querySelector(`.enhancement-checkbox[data-index="${idx}"]`);
                if (!checkbox || !checkbox.checked) return;

                // Handle COUNT_CLARIFICATION cards - calculate billing code from user-entered count
                if (e.priority === 'count_clarification' || e.enhanced_code === 'COUNT_CLARIFY') {
                    const countInput = document.querySelector(`.count-clarify-input[data-enh-index="${idx}"]`);
                    const countFamily = e.count_family;
                    if (countInput && countFamily && CODE_FAMILIES[countFamily]) {
                        const count = parseInt(countInput.value) || 1;
                        if (!familyCounts[countFamily]) familyCounts[countFamily] = 0;
                        familyCounts[countFamily] += count;

                        // Update the result display
                        const result = calculateFamilyWRVU(countFamily, count);
                        const resultSpan = document.getElementById(`count-clarify-result-${idx}`);
                        if (resultSpan && result.code) {
                            resultSpan.textContent = `→ ${result.code} (${result.wRVU.toFixed(2)} wRVU)`;
                        }
                    }
                    return;
                }

                // Skip medicolegal and LEGAL codes - they don't affect billing
                if (e.priority === 'medicolegal' || e.enhanced_code?.toUpperCase() === 'LEGAL') {
                    return;
                }

                const rawEnhCode = e.enhanced_code;
                if (!rawEnhCode) return;

                const enhCode = cleanCode(rawEnhCode);

                // Check for composite code like "99213 + G2211"
                const compositeMatch = rawEnhCode.match(/^99\d{3}\s*\+\s*(G\d{4})$/);
                if (compositeMatch) {
                    enhancementCodes.push({
                        code: compositeMatch[1],
                        description: 'Chronic care management add-on',
                        wRVU: MUE_DATA[compositeMatch[1]]?.wRVU || 0.33
                    });
                    return;
                }

                if (enhCode) {
                    const wRVU = MUE_DATA[enhCode]?.wRVU || e.enhanced_wRVU || 0;
                    enhancementCodes.push({
                        code: enhCode,
                        description: e.issue || `Enhanced code`,
                        wRVU: wRVU
                    });
                }
            });

            // Process family counts from count-clarification cards and add proper billing codes
            for (const [familyId, totalCount] of Object.entries(familyCounts)) {
                if (totalCount > 0) {
                    const result = calculateFamilyWRVU(familyId, totalCount);
                    if (result.code) {
                        const family = CODE_FAMILIES[familyId];
                        enhancementCodes.push({
                            code: result.code.split('+')[0], // Get base code for mutually exclusive handling
                            description: `${family.name} (${totalCount} total)`,
                            wRVU: result.wRVU,
                            isFromCountClarify: true
                        });
                    }
                }
            }

            // Build COMPLETE billing codes using the merge function
            // This handles mutually exclusive families and code upgrades
            const completeCodes = buildCompleteBillingCodes(baselineCodes, enhancementCodes);

            // Calculate total wRVU and delta
            const totalWRVU = completeCodes.reduce((sum, c) => sum + (c.wRVU || 0), 0);
            const deltaWRVU = totalWRVU - baselineWRVU;

            // Update the summary display
            const deltaDisplay = document.getElementById('enh-delta-display');
            const totalDisplay = document.getElementById('enh-total-display');
            if (deltaDisplay) deltaDisplay.textContent = '+' + deltaWRVU.toFixed(2);
            if (totalDisplay) totalDisplay.textContent = totalWRVU.toFixed(2);

            // Apply modifiers to complete codes
            const codesWithModifiers = applyModifiers(completeCodes);

            // Update the billing table - show COMPLETE billing codes (excluding non-billable codes)
            const tbody = document.getElementById('enh-billing-tbody');
            // Filter out LEGAL and COUNT_CLARIFY codes - they're for recommendation cards only, not billing
            const billableCodes = codesWithModifiers.filter(c => {
                const codeUpper = (c.code || '').toUpperCase().trim();
                return codeUpper !== 'LEGAL' && codeUpper !== 'COUNT_CLARIFY';
            });

            // Apply MUE limits and get warnings
            const { codes: mueCheckedCodes, warnings: mueWarnings } = applyMUELimits(billableCodes);

            // Display MUE warnings
            let warningContainer = document.getElementById('enh-mue-warnings');
            if (!warningContainer) {
                warningContainer = document.createElement('div');
                warningContainer.id = 'enh-mue-warnings';
                const table = document.getElementById('enh-billing-table');
                if (table) table.parentNode.insertBefore(warningContainer, table);
            }
            if (mueWarnings.length > 0) {
                warningContainer.innerHTML = mueWarnings.map(w => `
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 8px 12px; margin-bottom: 8px; color: #856404;">
                        <strong>⚠️ MUE Warning:</strong> ${w.message}
                    </div>
                `).join('');
            } else {
                warningContainer.innerHTML = '';
            }

            if (tbody) {
                if (mueCheckedCodes.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #6c757d;">No codes to bill</td></tr>`;
                } else {
                    tbody.innerHTML = mueCheckedCodes.map(c => {
                        const modifierDisplay = c.modifier ?
                            `<span class="modifier-badge" title="${c.modifierReason || ''}">${c.modifier}</span>` :
                            '-';
                        const rowStyle = c.mueExceeded
                            ? 'style="background: #fff3cd;"'
                            : (c.fromBaseline ? '' : 'style="background: #e8f5e9;"');
                        const upgradeIcon = c.upgraded ? '↑ ' : '';
                        const mueIcon = c.mueExceeded ? '⚠️ ' : '';
                        return `
                            <tr ${rowStyle}>
                                <td><strong>${mueIcon}${upgradeIcon}${c.code}</strong></td>
                                <td>${modifierDisplay}</td>
                                <td>${c.description}${c.mueExceeded ? ` <small>(MUE: ${c.mueLimit})</small>` : ''}</td>
                                <td><span class="wrvu-badge">${(c.wRVU || 0).toFixed(2)}</span></td>
                            </tr>
                        `;
                    }).join('') + `
                        <tr class="total-row">
                            <td colspan="3"><strong>TOTAL wRVU</strong></td>
                            <td><span class="wrvu-badge">${totalWRVU.toFixed(2)}</span></td>
                        </tr>
                    `;
                }
            }
        }

        function setupOpportunityListeners() {
            // Listen for checkbox changes
            document.querySelectorAll('.opportunity-checkbox').forEach(cb => {
                cb.addEventListener('change', updateOpportunityTotals);
            });
            // Listen for tier radio changes
            document.querySelectorAll('.tier-radio').forEach(radio => {
                radio.addEventListener('change', updateOpportunityTotals);
            });
            // Listen for count input changes (for count-based families)
            document.querySelectorAll('.count-input').forEach(input => {
                input.addEventListener('input', updateOpportunityTotals);
                input.addEventListener('change', updateOpportunityTotals);
            });
        }

        function updateOpportunityTotals() {
            if (!currentAnalysisData) return;

            const currentBilling = currentAnalysisData.current_billing;
            const opportunities = currentAnalysisData.future_opportunities.opportunities;
            const enhancements = currentAnalysisData.documentation_enhancements?.enhancements || [];
            const baselineCodes = currentBilling.codes || [];
            const baselineWRVU = currentBilling.total_wRVU;

            // Helper to extract clean CPT code
            function cleanCode(code) {
                if (!code) return null;
                const match = code.match(/^(99\d{3}|G\d{4}|\d{5})/);
                return match ? match[1] : code.trim();
            }

            // Collect enhancement codes first - SKIP LEGAL/medicolegal codes
            let additionalCodes = [];

            enhancements.forEach((e, idx) => {
                const checkbox = document.querySelector(`.enhancement-checkbox[data-index="${idx}"]`);
                if (!checkbox || !checkbox.checked) return;

                // Skip medicolegal and LEGAL codes - they don't affect billing
                if (e.priority === 'medicolegal' || e.priority === 'count_clarification') return;
                const rawEnhCode = e.enhanced_code;
                if (!rawEnhCode) return;
                if (rawEnhCode.toUpperCase().trim() === 'LEGAL' || rawEnhCode.toUpperCase().trim() === 'COUNT_CLARIFY') return;

                // Check for composite code like "99213 + G2211"
                const compositeMatch = rawEnhCode.match(/^99\d{3}\s*\+\s*(G\d{4})$/);
                if (compositeMatch) {
                    additionalCodes.push({
                        code: compositeMatch[1],
                        description: 'Chronic care management add-on',
                        wRVU: MUE_DATA[compositeMatch[1]]?.wRVU || 0.33
                    });
                    return;
                }

                const enhCode = cleanCode(rawEnhCode);
                if (enhCode) {
                    // Always use MUE_DATA wRVU if available
                    additionalCodes.push({
                        code: enhCode,
                        description: e.issue || 'Enhanced code',
                        wRVU: MUE_DATA[enhCode]?.wRVU || e.enhanced_wRVU || 0
                    });
                }
            });

            // Track family counts for count-based codes
            let familyCounts = {};

            // Process opportunities
            opportunities.forEach((o, idx) => {
                const checkbox = document.querySelector(`.opportunity-checkbox[data-index="${idx}"]`);
                if (!checkbox || !checkbox.checked) return;

                // Handle count-based families
                const familyId = checkbox.dataset.family;
                if (familyId && CODE_FAMILIES[familyId]) {
                    const countInput = document.querySelector(`.count-input[data-opp-index="${idx}"]`);
                    if (countInput) {
                        const count = parseInt(countInput.value) || 0;
                        if (!familyCounts[familyId]) familyCounts[familyId] = 0;
                        familyCounts[familyId] += count;
                    }
                    return;
                }

                let code, wRVU, desc;

                if (o.code_options && o.code_options.length > 0) {
                    const selectedRadio = document.querySelector(`input[name="tier-${idx}"]:checked`);
                    if (selectedRadio) {
                        code = selectedRadio.dataset.code;
                        wRVU = parseFloat(selectedRadio.dataset.wrvu) || 0;
                        desc = selectedRadio.dataset.desc;
                    } else {
                        return;
                    }
                } else if (o.potential_code) {
                    code = o.potential_code.code;
                    wRVU = MUE_DATA[code]?.wRVU || o.potential_code.wRVU || 0;
                    desc = o.potential_code.description;
                } else {
                    return;
                }

                if (code) {
                    additionalCodes.push({
                        code: code,
                        description: desc,
                        wRVU: wRVU,
                        fromOpportunity: true
                    });
                }
            });

            // Process family counts and add the appropriate tier code
            for (const [familyId, totalCount] of Object.entries(familyCounts)) {
                if (totalCount > 0) {
                    const result = calculateFamilyWRVU(familyId, totalCount);
                    if (result.code) {
                        const family = CODE_FAMILIES[familyId];
                        additionalCodes.push({
                            code: result.code,
                            description: `${family.name} (${totalCount} total)`,
                            wRVU: result.wRVU,
                            isAggregated: true
                        });
                    }
                }
            }

            // Build COMPLETE billing codes using the merge function
            // This handles mutually exclusive families and prevents duplicates
            const completeCodes = buildCompleteBillingCodes(baselineCodes, additionalCodes);

            // Calculate total wRVU and delta
            const totalWRVU = completeCodes.reduce((sum, c) => sum + (c.wRVU || 0), 0);
            const deltaWRVU = totalWRVU - baselineWRVU;

            // Update the summary display
            const deltaDisplay = document.getElementById('opp-delta-display');
            const totalDisplay = document.getElementById('opp-total-display');
            if (deltaDisplay) deltaDisplay.textContent = '+' + deltaWRVU.toFixed(2);
            if (totalDisplay) totalDisplay.textContent = totalWRVU.toFixed(2);

            // Apply modifiers to complete codes
            const codesWithModifiers = applyModifiers(completeCodes);

            // Update the billing table - show COMPLETE billing codes (excluding non-billable codes)
            const tbody = document.getElementById('opp-billing-tbody');
            // Filter out LEGAL and COUNT_CLARIFY codes - they're for recommendation cards only, not billing
            const billableCodes = codesWithModifiers.filter(c => {
                const codeUpper = (c.code || '').toUpperCase().trim();
                return codeUpper !== 'LEGAL' && codeUpper !== 'COUNT_CLARIFY';
            });

            // Apply MUE limits and get warnings
            const { codes: mueCheckedCodes, warnings: mueWarnings } = applyMUELimits(billableCodes);

            // Display MUE warnings
            let warningContainer = document.getElementById('opp-mue-warnings');
            if (!warningContainer) {
                warningContainer = document.createElement('div');
                warningContainer.id = 'opp-mue-warnings';
                const table = document.getElementById('opp-billing-table');
                if (table) table.parentNode.insertBefore(warningContainer, table);
            }
            if (mueWarnings.length > 0) {
                warningContainer.innerHTML = mueWarnings.map(w => `
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 8px 12px; margin-bottom: 8px; color: #856404;">
                        <strong>⚠️ MUE Warning:</strong> ${w.message}
                    </div>
                `).join('');
            } else {
                warningContainer.innerHTML = '';
            }

            if (tbody) {
                if (mueCheckedCodes.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #6c757d;">No codes to bill</td></tr>`;
                } else {
                    tbody.innerHTML = mueCheckedCodes.map(c => {
                        const rowStyle = c.mueExceeded
                            ? 'style="background: #fff3cd;"'
                            : (c.fromBaseline ? '' : 'style="background: #e8f5e9;"');
                        const upgradeIcon = c.upgraded ? '↑ ' : '';
                        const aggregatedIcon = c.isAggregated ? '⊕ ' : '';
                        const mueIcon = c.mueExceeded ? '⚠️ ' : '';
                        const modifierDisplay = c.modifier ?
                            `<span class="modifier-badge" title="${c.modifierReason || ''}">${c.modifier}</span>` :
                            '-';
                        return `
                            <tr ${rowStyle}>
                                <td><strong>${mueIcon}${upgradeIcon}${aggregatedIcon}${c.code}</strong></td>
                                <td>${modifierDisplay}</td>
                                <td>${c.description}${c.mueExceeded ? ` <small>(MUE: ${c.mueLimit})</small>` : ''}</td>
                                <td><span class="wrvu-badge">${(c.wRVU || 0).toFixed(2)}</span></td>
                            </tr>
                        `;
                    }).join('') + `
                        <tr class="total-row">
                            <td colspan="3"><strong>TOTAL wRVU</strong></td>
                            <td><span class="wrvu-badge">${totalWRVU.toFixed(2)}</span></td>
                        </tr>
                    `;
                }
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            });
        }

        async function regenerateNote(type) {
            if (!currentAnalysisData) {
                alert('No analysis data available. Please analyze a note first.');
                return;
            }

            const btnId = type === 'enhancements' ? 'regenerate-enh-btn' : 'regenerate-opp-btn';
            const statusId = type === 'enhancements' ? 'regenerate-enh-status' : 'regenerate-opp-status';
            const noteId = type === 'enhancements' ? 'optimized-note-enhancements' : 'optimized-note-opportunities';

            const btn = document.getElementById(btnId);
            const status = document.getElementById(statusId);

            // Get selected items
            let selectedEnhancements = [];
            let selectedOpportunities = [];

            if (type === 'enhancements') {
                const checkboxes = document.querySelectorAll('.enhancement-checkbox:checked');
                checkboxes.forEach(cb => {
                    const idx = parseInt(cb.dataset.index);
                    selectedEnhancements.push(currentAnalysisData.documentation_enhancements.enhancements[idx]);
                });
            } else {
                const checkboxes = document.querySelectorAll('.opportunity-checkbox:checked');
                checkboxes.forEach(cb => {
                    const idx = parseInt(cb.dataset.index);
                    const opp = currentAnalysisData.future_opportunities.opportunities[idx];

                    // For tiered opportunities, get the selected tier and convert to potential_code format
                    if (opp.code_options && opp.code_options.length > 0) {
                        const selectedRadio = document.querySelector(`input[name="tier-${idx}"]:checked`);
                        if (selectedRadio) {
                            // Create a modified opportunity with selected tier as potential_code
                            const modifiedOpp = {
                                ...opp,
                                potential_code: {
                                    code: selectedRadio.dataset.code,
                                    description: selectedRadio.dataset.desc,
                                    wRVU: parseFloat(selectedRadio.dataset.wrvu) || 0
                                },
                                code_options: null // Clear code_options since we've selected one
                            };
                            selectedOpportunities.push(modifiedOpp);
                        }
                    } else {
                        selectedOpportunities.push(opp);
                    }
                });
            }

            if (selectedEnhancements.length === 0 && selectedOpportunities.length === 0) {
                alert('Please select at least one recommendation to include.');
                return;
            }

            // Disable button and show loading
            btn.disabled = true;
            btn.textContent = 'Regenerating...';
            status.textContent = 'Processing...';

            try {
                // Get current billing codes from Step 2
                const currentBillingCodes = currentAnalysisData.current_billing?.codes || [];

                const response = await fetch('/regenerate-note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        original_note: currentAnalysisData.original_note,
                        selected_enhancements: selectedEnhancements,
                        selected_opportunities: selectedOpportunities,
                        current_billing_codes: currentBillingCodes
                    })
                });

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error('Invalid response');
                }

                if (!response.ok) {
                    throw new Error(data.detail || 'Regeneration failed');
                }

                // Build billing codes display
                let billingHtml = '<div style="background: #e8f5e9; border-radius: 8px; padding: 15px; margin-bottom: 15px;">';
                billingHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">Billing Codes for Optimized Note</h4>';
                billingHtml += '<table style="width: 100%; border-collapse: collapse;">';
                billingHtml += '<tr style="background: #c8e6c9;"><th style="padding: 8px; text-align: left;">Code</th><th style="padding: 8px; text-align: left;">Modifier</th><th style="padding: 8px; text-align: left;">Description</th><th style="padding: 8px; text-align: right;">wRVU</th></tr>';

                if (data.billing_codes && data.billing_codes.length > 0) {
                    data.billing_codes.forEach(code => {
                        billingHtml += `<tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; font-weight: bold;">${code.code}</td>
                            <td style="padding: 8px;">${code.modifier || '-'}</td>
                            <td style="padding: 8px;">${code.description}</td>
                            <td style="padding: 8px; text-align: right;">${code.wRVU.toFixed(2)}</td>
                        </tr>`;
                    });
                    billingHtml += `<tr style="background: #c8e6c9; font-weight: bold;">
                        <td colspan="3" style="padding: 8px;">TOTAL</td>
                        <td style="padding: 8px; text-align: right;">${data.total_wRVU.toFixed(2)}</td>
                    </tr>`;
                }
                billingHtml += '</table></div>';

                // Update the optimized note section with billing codes + note
                const noteContainer = document.getElementById(noteId);
                noteContainer.innerHTML = billingHtml + '<div style="white-space: pre-wrap;">' + data.optimized_note + '</div>';

                status.textContent = `✓ Note regenerated with ${data.included_enhancements + data.included_opportunities} recommendations (${data.total_wRVU.toFixed(2)} wRVU)`;
                status.style.color = '#28a745';

            } catch (err) {
                status.textContent = 'Error: ' + err.message;
                status.style.color = '#dc3545';
            } finally {
                btn.disabled = false;
                btn.textContent = type === 'enhancements'
                    ? 'Regenerate Note with Selected Enhancements'
                    : 'Regenerate Note with Selected Opportunities';
            }
        }
    </script>
</body>
</html>
